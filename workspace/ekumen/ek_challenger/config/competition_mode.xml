<root main_tree_to_execute="root">

    <BehaviorTree ID="root">
        <Sequence>
            <SubTree ID="FullCompetitionMode" />
        </Sequence>
    </BehaviorTree>

    <BehaviorTree ID="FullCompetitionMode">
        <Repeat num_cycles="-1">
            <Sequence>
                <!-- <SubTree ID="GetInRestPose" /> -->
                <SubTree ID="AnalyzeEnvironment" />
                <Fallback>
                    <SubTree ID="DoYourTrick" />
                    <Pause time_limit_sec="30"/>
                </Fallback> -->
            </Sequence>
        </Repeat>
    </BehaviorTree>

    <BehaviorTree ID="AnalyzeEnvironment">
        <ForceSuccess>
            <Sequence>
                <TrayUpdatePlanningScene />
                <AlwaysFailure/>
                <MoveBase goal="0;0;0"/>
                <HeadControl pitch="30.0" yaw="45" />
                <HeadControl pitch="30.0" yaw="135" />
                <HeadControl pitch="-30.0" yaw="45" />
                <HeadControl pitch="-30.0" yaw="135" />
                <MoveBase goal="2;-1;1.57"/>
                <HeadControl pitch="30.0" yaw="45" />
                <HeadControl pitch="30.0" yaw="135" />
                <HeadControl pitch="-30.0" yaw="45" />
                <HeadControl pitch="-30.0" yaw="135" />
            </Sequence>
        </ForceSuccess>
    </BehaviorTree>



    <BehaviorTree ID="GetInRestPose">
        <Sequence>
            <GetArmJointsForPose pose="REST" joints_pose="{joints_pose}" />
            <Parallel success_threshold="3" failure_threshold="3">
                <Sequence >
                    <HeadControl pitch="0" yaw="90" />
                    <TorsoControl relative_height="0.95" />
                </Sequence>
                <SetArmJointsLeft joints_pose="{joints_pose}" />
                <SetArmJointsRight joints_pose="{joints_pose}" />
            </Parallel>
        </Sequence>
    </BehaviorTree>

    <BehaviorTree ID="GetInUpTrayPose">
        <Sequence>
            <GetArmJointsForPose pose="UPTRAY" joints_pose="{joints_pose}" />
            <Parallel success_threshold="2" failure_threshold="2">
                <SetArmJointsLeft joints_pose="{joints_pose}" />
                <SetArmJointsRight joints_pose="{joints_pose}" />
            </Parallel>
        </Sequence>
    </BehaviorTree>

    <!-- <BehaviorTree ID="UpdateOctomap">
        <ForceSuccess>
            <Sequence>
                <HeadControl pitch="30.0" yaw="135" />
                <Pause time_limit_sec="1"/>
                <HeadControl pitch="-30.0" yaw="135" />
                <Pause time_limit_sec="1"/>
            </Sequence>
        </ForceSuccess>
    </BehaviorTree> -->


    <BehaviorTree ID="DoYourTrick">
        <Sequence>
            <ForceSuccess>
                <SubTree ID="FillYourTray" />
            </ForceSuccess>
            <ForceSuccess>
                <SubTree ID="FillTheShelf" />
            </ForceSuccess>
        </Sequence>
    </BehaviorTree>


    <BehaviorTree ID="ScanTable">
        <Sequence>
            <TorsoControl relative_height="0.95" />
            <HeadControl pitch="10.0" yaw="140.0" />
            <ScanTableStartScanning />
            <Pause time_limit_sec="2"/>
            <ScanTableGetResults detected_tomato_cans="{detected_tomato_cans}" />
            <TraySetLoci tray_name="table" locus_poses="{detected_tomato_cans}" occupied="true" />
        </Sequence>
    </BehaviorTree>

    <BehaviorTree ID="ScanShelves">
        <Sequence>
            <TorsoControl relative_height="0.0" />
            <HeadControl pitch="0.0" yaw="90.0" />
            <ScanShelves tomato_can_stocking_target_poses="{tomato_can_stocking_target_poses}" />
            <TraySetLoci tray_name="shelf" locus_poses="{tomato_can_stocking_target_poses}" occupied="false" />
        </Sequence>
    </BehaviorTree>

    <BehaviorTree ID="FillYourTray">
        <Sequence>
            <ClearShelfObstacles />
            <SubTree ID="GetInUpTrayPose" />
            <SubTree ID="GoToTable" />
            <SubTree ID="ScanTable" />
            <!-- <SubTree ID="UpdateOctomap" /> -->
            <TrayUpdatePlanningScene />
            <SetBlackboard output_key="src_tray" value="table" />
            <SetBlackboard output_key="dst_tray" value="backtray" />
            <SubTree ID="MoveTomatoCans" src_tray="src_tray" dst_tray="dst_tray" />
            <Backtrack target_distance_m="1.0"/>

        </Sequence>
    </BehaviorTree>

    <BehaviorTree ID="GoToTable">
        <Sequence>
            <!-- <MoveBase goal="1.0;-1.0;0"/> -->
            <!-- <Backtrack target_distance_m="0.4"/> -->
            <MoveBase goal="1.0;-1.5;0.0"/>
            <!-- front -->
            <MoveBase goal="2.0;-0.5;0.3"/>
            <!-- front -->
            <!-- <MoveBase goal="3;-0.7;1.57"/> -->
        </Sequence>
    </BehaviorTree>

    <BehaviorTree ID="GoToShelves">
        <Sequence>
            <MoveBase goal="2.0;-1.5;1.57"/>
            <MoveBase goal="2.0;-0.1;1.57"/>
        </Sequence>
    </BehaviorTree>


    <BehaviorTree ID="FillTheShelf">
        <Sequence>
            <ClearShelfObstacles />
            <SubTree ID="GetInUpTrayPose" />
            <SubTree ID="GoToShelves" />
            <SubTree ID="ScanShelves" />
            <!-- <SubTree ID="UpdateOctomap" /> -->
            <TrayUpdatePlanningScene />
            <SetBlackboard output_key="src_tray" value="backtray" />
            <SetBlackboard output_key="dst_tray" value="shelf" />
            <SubTree ID="MoveTomatoCans" src_tray="src_tray" dst_tray="dst_tray" />
            <Backtrack target_distance_m="1.0"/>
        </Sequence>
    </BehaviorTree>

    <BehaviorTree ID="MoveTomatoCans">
        <Repeat num_cycles="4">
            <ForceSuccess>
                <KeepRunningUntilFailure>
                    <Fallback>
                        <Sequence>
                            <SubTree ID="LeftArmFillYourTray" src_tray="src_tray" dst_tray="dst_tray" />
                            <SubTree ID="RightArmFillYourTray" src_tray="src_tray" dst_tray="dst_tray" />
                        </Sequence>
                        <SubTree ID="RightArmFillYourTray" src_tray="src_tray" dst_tray="dst_tray" />
                        <ForceFailure>
                            <SubTree ID="GetInUpTrayPose" />
                        </ForceFailure>
                    </Fallback>
                </KeepRunningUntilFailure>
            </ForceSuccess>
        </Repeat>
    </BehaviorTree>

    <BehaviorTree ID="LeftArmFillYourTray">
        <Sequence>
            <TrayPickOccupiedLocus tray_name="{src_tray}" side="LEFT" locus_id="{src_locus_id}" />
            <Fallback>
                <Sequence>
                    <TrayPickEmptyLocus tray_name="{dst_tray}" side="LEFT" locus_id="{dst_locus_id}" locus_pose="{dst_locus_pose}" />
                    <Fallback>
                        <Sequence>
                            <TrayUpdatePlanningScene />
                            <PickAndPlaceLeft object_id="{src_locus_id}" target_pose="{dst_locus_pose}" />
                            <TraySetLocusState tray_name="{src_tray}" locus_id="{src_locus_id}" occupied="false" />
                            <TraySetLocusState tray_name="{dst_tray}" locus_id="{dst_locus_id}" occupied="true" />
                        </Sequence>
                        <ForceFailure>
                            <TrayReleaseLocus tray_name="{dst_tray}" locus_id="{dst_locus_id}" />
                        </ForceFailure>
                    </Fallback>
                    <TrayReleaseLocus tray_name="{dst_tray}" locus_id="{dst_locus_id}" />
                </Sequence>
                <ForceFailure>
                    <TrayReleaseLocus tray_name="{src_tray}" locus_id="{src_locus_id}" />
                </ForceFailure>
            </Fallback>
            <TrayReleaseLocus tray_name="{src_tray}" locus_id="{src_locus_id}" />
        </Sequence>
    </BehaviorTree>

    <BehaviorTree ID="RightArmFillYourTray">
        <Sequence>
            <TrayPickOccupiedLocus tray_name="{src_tray}" side="RIGHT" locus_id="{src_locus_id}" />
            <Fallback>
                <Sequence>
                    <TrayPickEmptyLocus tray_name="{dst_tray}" side="RIGHT" locus_id="{dst_locus_id}" locus_pose="{dst_locus_pose}" />
                    <Fallback>
                        <Sequence>
                            <TrayUpdatePlanningScene />
                            <PickAndPlaceRight object_id="{src_locus_id}" target_pose="{dst_locus_pose}" />
                            <TraySetLocusState tray_name="{src_tray}" locus_id="{src_locus_id}" occupied="false" />
                            <TraySetLocusState tray_name="{dst_tray}" locus_id="{dst_locus_id}" occupied="true" />
                        </Sequence>
                        <ForceFailure>
                            <TrayReleaseLocus tray_name="{dst_tray}" locus_id="{dst_locus_id}" />
                        </ForceFailure>
                    </Fallback>
                    <TrayReleaseLocus tray_name="{dst_tray}" locus_id="{dst_locus_id}" />
                </Sequence>
                <ForceFailure>
                    <TrayReleaseLocus tray_name="{src_tray}" locus_id="{src_locus_id}" />
                </ForceFailure>
            </Fallback>
            <TrayReleaseLocus tray_name="{src_tray}" locus_id="{src_locus_id}" />
        </Sequence>
    </BehaviorTree>

</root>

